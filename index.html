<!DOCTYPE html>
<html lang="en-nz">
    <head>
        <title>cover maker</title>
        <style>
            canvas {
                border: 1px black solid;
                cursor: grab;
            }
            canvas.dragging {
                cursor: grabbing;
            }
        </style>
    </head>
    <body id="body">
        <input type="file" id="imageLoader" name="imageLoader"/><br/>
        <button id="zoomIn">zoom background in</button>
        <button id="zoomOut">zoom background out</button><br/>
        Title colour: <input type="color" id="titleColourPicker" name="titleColourPicker" value="#000000" /><br/>
        Lead text: <textarea id="leadText">The photo of&#13;&#10;the generation?</textarea><button id="leadTextIncrease">Make bigger</button><button id="leadTextDecrease">Make small</button><br/>
        Article 1 text: <textarea id="articleText1">What could&#13;&#10;it be?</textarea><br/>
        Article 2 text: <textarea id="articleText2">Is it&#13;&#10;just a blur?</textarea><br/>
        Article 3 text: <textarea id="articleText3">No!&#13;&#10;definitely pengiun!</textarea><br/>
        <canvas id="imageCanvas" width="500" height="655"></canvas>
        <script>
            var canvas = document.getElementById('imageCanvas');
            var ctx = canvas.getContext('2d');

            document.getElementById('imageLoader').addEventListener('change', handleImage, false);
            document.getElementById('zoomIn').addEventListener('click', handleZoomIn, false);
            document.getElementById('zoomOut').addEventListener('click', handleZoomOut, false);
            // we do the mousedown event on the canvas for when they start dragging the background image
            // but we do the mouse up and mouse move for the whole document, because they might
            // drag the mouse off the canvas and then we wouldn't see the event
            canvas.addEventListener('mousedown', handleMouseDown, false);
            document.getElementById('body').addEventListener('mouseup', handleMouseUp, false);
            document.getElementById('body').addEventListener('mousemove', handleMouseMove, false);

            
            canvas.addEventListener('mouseenter', handleCanvasMouseIn, false);
            canvas.addEventListener('mouseout', handleCanvasMouseOut, false);

            document.getElementById('titleColourPicker').addEventListener("input", handleTitleColourPickerSet, false);

            document.getElementById('articleText1').addEventListener('change', handleArticleTextChange, false);
            document.getElementById('articleText2').addEventListener('change', handleArticleTextChange, false);
            document.getElementById('articleText3').addEventListener('change', handleArticleTextChange, false);
            document.getElementById('leadText').addEventListener('change', handleArticleTextChange, false);

            document.getElementById('leadTextIncrease').addEventListener('click', handleLeadTextSizeIncrease, false);
            document.getElementById('leadTextDecrease').addEventListener('click', handleLeadTextSizeDecrease, false);


            var cvWidth = canvas.width;     // get the width and height so we can clear the canvas
            var cvHeight = canvas.height;

            var img = new Image();              // holds the background image uploaded by the user
            var moveIconImg = new Image();
            moveIconImg.src = "images/moveIcon.png";
            var barCodeImg = new Image();
            barCodeImg.src = "images/barCode.png";
            var backgroundImageReady = false;   // indicates if the user selected image has been loaded yet (i.e. is ready for drawing)
            var zoom = 1;                       // the zoom on the background image
            var imageStartX = 0;                // x position to start drawing the background image
            var imageStartY = 0;                // y position to start drawing the background image
            var draggingImage = false;          // indicates if the user is currently dragging their mouse
            var lastDragCoordinates = {x:0,y:0} // the co-ordinates where the mouse was last seen during a drag
            var titleColour = "#000000";        // the colour of the title text
            var leadTextCoordinates = {x:cvWidth/2,y:cvHeight/2}

            var articleText1 = "";
            var articleText2 = "";
            var articleText3 = "";
            var leadText = "";
            var leadTextSize = 30;

            const month = new Date().toLocaleString('default', { month: 'long' });
            const year = new Date().getFullYear()
            var issueText = month + " " + year;

            var editMode = false;
            var draggingLeadText = false;

            function handleTitleColourPickerSet(event) {
                titleColour = event.target.value
            }
            function handleCanvasMouseIn() {
                editMode = true;
            }
            function handleCanvasMouseOut() {
                editMode = false;
            }
            function handleMouseDown(event) {
                lastDragCoordinates.x = event.pageX;
                lastDragCoordinates.y = event.pageY;
                // depending on where the user has clicked we are either moving the background image or
                // the lead text - check to see if they clicked in the center of the lead text where the
                // move icon is
                var rect = canvas.getBoundingClientRect();
                // console.log("page: " + event.pageX + ", " + event.pageY)
                // console.log("text: " + leadTextCoordinates.x + ", " + (leadTextCoordinates.y + 15 + rect.top + window.scrollY))
                if( (event.pageX < (leadTextCoordinates.x + 15 + rect.left)) && (event.pageX > (leadTextCoordinates.x - 15 + rect.left)) &&
                (event.pageY < (leadTextCoordinates.y + 15 + rect.top + window.scrollY)) && (event.pageY > (leadTextCoordinates.y - 15 + rect.top + window.scrollY))) 
                {
                    draggingLeadText = true;
                } else {
                    draggingImage = true;
                }
                
                canvas.classList.add("dragging");
            }
            function handleMouseUp(event) {
                draggingImage = false;
                draggingLeadText = false;
                canvas.classList.remove("dragging");
            }
            function handleLeadTextSizeIncrease() {
                leadTextSize = leadTextSize + 2;
            }
            function handleLeadTextSizeDecrease() {
                leadTextSize = leadTextSize - 2;
            }
            function handleMouseMove(event) {
                let deltaX = event.pageX - lastDragCoordinates.x;
                let deltaY = event.pageY - lastDragCoordinates.y;
                if(draggingLeadText) {
                    leadTextCoordinates.x = leadTextCoordinates.x + deltaX;
                    leadTextCoordinates.y = leadTextCoordinates.y + deltaY;
                }
                if(draggingImage) {
                    imageStartX = imageStartX + deltaX;
                    imageStartY = imageStartY + deltaY;
                }
                lastDragCoordinates.x = event.pageX;
                lastDragCoordinates.y = event.pageY;
            }

            function handleZoomIn() {
                zoom = zoom + 0.1;
            }
            function handleZoomOut() {
                zoom = zoom - 0.1;
                if(zoom <= 0) {
                    zoom = 0.1;
                    alert("can't zoom out further")
                }
            }

            function handleImage(e){
                var reader = new FileReader();
                reader.onload = function(event){
                    img.onload = function(){
                        backgroundImageReady = true;
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(e.target.files[0]);     
            }

            function handleArticleTextChange() {
                articleText1 = document.getElementById('articleText1').value;
                articleText2 = document.getElementById('articleText2').value;
                articleText3 = document.getElementById('articleText3').value;
                leadText = document.getElementById('leadText').value;
            }
            handleArticleTextChange();  // update the first time

            function drawTitle() {
                ctx.textAlign = "left";
                ctx.fillStyle = titleColour;
                ctx.font = "100px serif";
                ctx.fillText("G", 10, 100);
                ctx.font = "70px serif";
                ctx.fillText("EOGRAPHIC", 85, 100);
                ctx.font = "bold 16px Arial";
                ctx.fillText("NEW ZEALAND", 85, 45);
            }

            function drawArticleText(articleText, xPos, startY) {
                var lines = articleText.split("\n");
                let yPos = startY;
                for(let x = lines.length-1; x >= 0; x--) {
                    ctx.font = "bold 15px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText(lines[x], xPos, yPos);
                    yPos = yPos - 20;
                }
            }
            function drawLeadText() {
                ctx.font = leadTextSize + "px Arial";
                ctx.textAlign = "center";
                var lines = leadText.split("\n");
                let yPos = leadTextCoordinates.y;
                for(let x = 0; x < lines.length; x++) {
                    ctx.fillText(lines[x], leadTextCoordinates.x, yPos);
                    yPos = yPos + leadTextSize;
                }
                if(editMode) {
                    let imageSize = 30;
                    ctx.drawImage(moveIconImg,leadTextCoordinates.x - (imageSize / 2),leadTextCoordinates.y - (imageSize / 2),imageSize,imageSize);
                }
            }

            function drawPageChrome() {
                ctx.drawImage(barCodeImg,0, cvHeight - 100);
                ctx.save();
                ctx.font = "10px Arial";
                ctx.translate(20, 500);
                ctx.rotate(-Math.PI/2);
                ctx.fillText(issueText, 0, 0);
                ctx.restore();
            }

            // looping is a bit unnecessary
            function drawLoop() {
                // clear canvas
                ctx.clearRect(0, 0, cvWidth, cvHeight);
                
                // draw everything
                if(backgroundImageReady) {
                    ctx.drawImage(img,imageStartX,imageStartY,img.width*zoom,img.height*zoom);
                }
                drawPageChrome();
                drawTitle();
                drawLeadText();
                drawArticleText(articleText1, cvWidth / 5, cvHeight - 50)
                drawArticleText(articleText2, cvWidth / 2, cvHeight - 50)
                drawArticleText(articleText3, cvWidth * 4/5, cvHeight - 50)

                // call again next time we can draw
                requestAnimationFrame(drawLoop);
            }

            drawLoop();
        </script>
    </body>
</html>